{"id":"752fe78e-d727-4c25-86e0-c9ecad70da56","rev":1,"v":"1","name":"Sophos XG Pipeline","summary":"Graylog Pipeline Rules ","description":"","vendor":"Jeff Singleton (@HackDefendr)","url":"https://github.com/hackdefendr/SophosXG_Graylog","created_at":"2020-05-26T01:20:14.461Z","server_version":"3.3.0+4ea5649","parameters":[],"entities":[{"id":"6eea66ad-23c3-45b8-9995-d514032f3111","type":{"name":"pipeline","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Sophos XG"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"pipeline \"Sophos XG\"\nstage 0 match all\nrule \"priority name\"\nstage 1 match all\nrule \"GeoIP lookup: dst_ip\"\nrule \"GeoIP lookup: src_ip\"\nstage 2 match either\nrule \"XG Firewall Type\"\nrule \"XG Content Filter Type\"\nend"},"connected_streams":[{"@type":"string","@value":"000000000000000000000001"}]},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"b3e8a24f-19ca-4b4c-a6ae-e05bf7e8d6d5","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"GeoIP lookup: src_ip"},"description":{"@type":"string","@value":"Source GeoIP Lookup"},"source":{"@type":"string","@value":"rule \"GeoIP lookup: src_ip\"\n  when\n    has_field(\"src_ip\")\n  then\n    let geo = lookup(\"geoip\", to_string($message.src_ip));\n    set_field(\"src_ip_geo_location\", geo[\"coordinates\"]);\n    set_field(\"src_country_code\", geo[\"country\"].iso_code);\n    set_field(\"src_ip_geo_city\", geo[\"city\"].names.en);\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"1fcb65ca-cce7-44c5-8dae-320d8c03fd7a","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG Log Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG Log Type\"\nwhen\n    to_string($message.source) == \"xg.lan.paravantage.com\"\nthen\n    set_fields(\n        grok(\n            pattern: \"log_type=%{QUOTEDSTRING:log_type} log_component=%{QUOTEDSTRING:log_component} log_subtype=%{QUOTEDSTRING:log_sub_type}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"2ffb5b6e-6b3a-44be-936a-dfc0b580cadb","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"priority name"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"priority name\"\nwhen\n    true\nthen\n    set_field(\"priority\",syslog_level($message.priority));\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"384487f5-38d8-4cc8-81e9-886162878bfd","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"GeoIP lookup: dst_ip"},"description":{"@type":"string","@value":"Destination GeoIP Lookup"},"source":{"@type":"string","@value":"rule \"GeoIP lookup: dst_ip\"\n  when\n    has_field(\"dst_ip\")\n  then\n    let geo = lookup(\"geoip\", to_string($message.dst_ip));\n    set_field(\"dst_ip_geo_location\", geo[\"coordinates\"]);\n    set_field(\"dst_country_code\", geo[\"country\"].iso_code);\n    set_field(\"dst_ip_geo_city\", geo[\"city\"].names.en);\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"a2a337d9-6f35-4478-aad6-d7e14bff10c8","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"Pipeline Processed Flag"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"Pipeline Processed Flag\"\nwhen\n    true\nthen\n    set_field(\"pipeline_processed\",true);\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"0b9d4f7a-5975-4d06-a455-a9b971950698","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG Event Authentication Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG Event Authentication Type\"\nwhen\n    (to_string($message.log_type) == \"Event\") && (to_string($message.log_sub_type) == \"Authentication\")\nthen\n    set_fields(\n        grok(\n            pattern: \"status=%{QUOTEDSTRING:status}%{SPACE}priority=%{WORD:priority}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{SPACE}usergroupname=%{QUOTEDSTRING:user_group}%{SPACE}auth_client=%{QUOTEDSTRING:auth_client}%{SPACE}auth_mechanism=%{QUOTEDSTRING:auth_mechanism}%{SPACE}reason=%{QUOTEDSTRING:reason}%{SPACE}src_ip=%{DATA:src_ip}%{SPACE}message=%{QUOTEDSTRING:auth_message}%{SPACE}name=%{QUOTEDSTRING:name}%{SPACE}src_mac=%{DATA:src_mac}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"1169c7dc-3490-4297-8fd2-904d2eb8e5c1","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG System Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG System Type\"\nwhen\n    to_string($message.log_sub_type) == \"System\"\nthen\n    set_fields(\n        grok(\n            pattern: \"(status=%{QUOTEDSTRING:status})?%{SPACE}priority=%{WORD:priority}%{SPACE}(status=%{QUOTEDSTRING:status})?%{GREEDYDATA}message=%{QUOTEDSTRING:system_message}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"8d4ff0e5-3820-4a7f-96bf-55c103a8079d","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG Content Filter Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG Content Filter Type\"\nwhen\n    to_string($message.log_type) == \"Content Filtering\"\nthen\n    set_fields(\n        grok(\n            pattern: \"status=%{QUOTEDSTRING:action}%{SPACE}priority=%{GREEDYDATA:priority}%{SPACE}fw_rule_id=%{INT:fw_rule_id}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{SPACE}user_gp=%{QUOTEDSTRING:user_group}%{SPACE}iap=%{INT:iap}%{SPACE}category=%{QUOTEDSTRING:category}%{SPACE}category_type=%{QUOTEDSTRING:category_type}%{SPACE}url=%{QUOTEDSTRING:url}%{SPACE}contenttype=%{QUOTEDSTRING:content_type}%{SPACE}override_token=%{QUOTEDSTRING:override_token}%{SPACE}httpresponsecode=%{QUOTEDSTRING:http_response_code}%{SPACE}src_ip=%{IP:src_ip}%{SPACE}dst_ip=%{IP:dst_ip}%{SPACE}protocol=%{QUOTEDSTRING:protocol}%{SPACE}src_port=%{INT:src_port}%{SPACE}dst_port=%{INT:dst_port}%{SPACE}sent_bytes=%{INT:sent_bytes;int}%{SPACE}recv_bytes=%{INT:recv_bytes;int}%{SPACE}domain=%{URIHOST:domain}%{SPACE}exceptions=%{DATA:exceptions}%{SPACE}activityname=%{QUOTEDSTRING:activity_name}%{SPACE}reason=%{QUOTEDSTRING:reason}%{SPACE}user_agent=%{QUOTEDSTRING:user_agent}%{SPACE}status_code=%{QUOTEDSTRING:status_code}%{SPACE}transactionid=%{DATA:transaction_id}%{SPACE}referer=%{QUOTEDSTRING:referer}%{SPACE}download_file_name=%{QUOTEDSTRING:downloaded_file_name}%{SPACE}download_file_type=%{QUOTEDSTRING:downloaded_file_type}%{SPACE}upload_file_name=%{QUOTEDSTRING}%{SPACE}upload_file_type=%{QUOTEDSTRING}%{SPACE}con_id=%{INT:con_id}%{SPACE}application=%{QUOTEDSTRING:application}%{SPACE}app_is_cloud=%{INT:app_is_cloud;boolean}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"005fdde0-9a3e-4d91-982d-7739f4c5ae74","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG Firewall Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG Firewall Type\"\nwhen\n    to_string($message.log_type) == \"Firewall\"\nthen\n    set_fields(\n        grok(\n            pattern: \"status=%{QUOTEDSTRING:action}%{SPACE}priority=%{WORD:priority}%{SPACE}duration=%{INT:duration}%{SPACE}fw_rule_id=%{INT:fw_rule_id}%{SPACE}policy_type=%{INT:policy_type}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{SPACE}user_gp=%{QUOTEDSTRING:user_group}%{SPACE}iap=%{INT:iap}%{SPACE}ips_policy_id=%{INT:ips_policy_id}%{SPACE}appfilter_policy_id=%{INT:app_filter_policy_id}%{SPACE}application=%{QUOTEDSTRING:application}%{SPACE}application_risk=%{INT:application_risk}%{SPACE}application_technology=%{QUOTEDSTRING:application_technology}%{SPACE}application_category=%{QUOTEDSTRING:application_category}%{SPACE}in_interface=%{QUOTEDSTRING:in_interface}%{SPACE}out_interface=%{QUOTEDSTRING:out_interface}%{SPACE}src_mac=%{DATA:src_mac}%{SPACE}src_ip=%{DATA:src_ip}%{SPACE}src_country_code=%{DATA:src_country_code}%{SPACE}dst_ip=%{DATA:dst_ip}%{SPACE}dst_country_code=%{DATA:dst_country_code}%{SPACE}protocol=%{QUOTEDSTRING:protocol}%{SPACE}(src_port=%{INT:src_port}%{SPACE}dst_port=%{INT:dst_port})?(icmp_type=%{INT:icmp_type}%{SPACE}icmp_code=%{INT:icmp_code})?%{SPACE}sent_pkts=%{INT:sent_pkts;int}%{SPACE}recv_pkts=%{INT:recv_pkts;int}%{SPACE}sent_bytes=%{INT:sent_bytes;int}%{SPACE}recv_bytes=%{INT:recv_bytes;int}%{SPACE}tran_src_ip=%{DATA:tran_src_ip}%{SPACE}tran_src_port=%{INT:tran_src_port}%{SPACE}tran_dst_ip=%{DATA:tran_dst_ip}%{SPACE}tran_dst_port=%{INT:tran_dst_port}%{SPACE}srczonetype=%{QUOTEDSTRING:src_zone_type}%{SPACE}srczone=%{QUOTEDSTRING:src_zone}%{SPACE}dstzonetype=%{QUOTEDSTRING:dst_zone_type}%{SPACE}dstzone=%{QUOTEDSTRING:dst_zone}%{SPACE}dir_disp=%{QUOTEDSTRING:dir_disp}%{SPACE}(connevent=%{QUOTEDSTRING:conn_event})?%{SPACE}connid=%{QUOTEDSTRING:conn_id}%{SPACE}vconnid=%{QUOTEDSTRING:v_conn_id}%{SPACE}hb_health=%{QUOTEDSTRING:hb_health}%{SPACE}message=%{QUOTEDSTRING:fw_message}%{SPACE}appresolvedby=%{QUOTEDSTRING:app_resolved_by}%{SPACE}app_is_cloud=%{INT:app_is_cloud;boolean}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"ef64080c-a74e-48af-bf59-ac3b9fa72964","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG GUI Event Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG GUI Event Type\"\nwhen\n    to_string($message.log_type) == \"Event\" && to_string($message.log_component) == \"GUI\"\nthen\n    set_fields(\n        grok(\n            pattern: \"status=%{DATA:QUOTEDSTRING}%{SPACE}priority=%{WORD:priority}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{SPACE}src_ip=%{DATA:src_ip}%{SPACE}ZONE=%{QUOTEDSTRING:zone}%{SPACE}message=%{QUOTEDSTRING:event_message}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"0be40db9-52cc-4de5-b2d4-3766100a2921","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG IDP Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG IDP Type\"\nwhen\n    to_string($message.log_type) == \"IDP\"\nthen\n    set_fields(\n        grok(\n            pattern: \"priority=%{WORD:priority}%{SPACE}idp_policy_id=%{INT:idp_policy_id}%{SPACE}fw_rule_id=%{INT:fw_rule_id}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{SPACE}signature_id=%{INT:signature_id}%{SPACE}signature_msg=%{QUOTEDSTRING:signature_msg}%{SPACE}classification=%{QUOTEDSTRING:classification}%{SPACE}rule_priority=%{INT:rule_priority}%{SPACE}src_ip=%{DATA:src_ip}%{SPACE}src_country_code=%{DATA:src_country_code}%{SPACE}dst_ip=%{DATA:dst_ip}%{SPACE}dst_country_code=%{DATA:dst_country_code}%{SPACE}protocol=%{QUOTEDSTRING:protocol}%{SPACE}src_port=%{INT:src_port}%{SPACE}dst_port=%{INT:dst_port}%{SPACE}platform=%{QUOTEDSTRING:platform}%{SPACE}category=%{QUOTEDSTRING:category}%{SPACE}target=%{QUOTEDSTRING:target}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]},{"id":"6ccb3350-660a-4534-a7c7-3eb91d5b5566","type":{"name":"pipeline_rule","version":"1"},"v":"1","data":{"title":{"@type":"string","@value":"XG SMTP Type"},"description":{"@type":"string","@value":""},"source":{"@type":"string","@value":"rule \"XG SMTP Type\"\nwhen\n    to_string($message.log_component) == \"SMTP\"\nthen\n    set_fields(\n        grok(\n            pattern: \"priority=%{WORD:priority}%{SPACE}fw_rule_id=%{INT:fw_rule_id}%{SPACE}user_name=%{QUOTEDSTRING:user_name}%{GREEDYDATA}from_email_address=%{QUOTEDSTRING:from_email_address}%{SPACE}to_email_address=%{QUOTEDSTRING:to_email_address}%{SPACE}email_subject=%{QUOTEDSTRING:email_subject}%{GREEDYDATA}src_domainname=%{QUOTEDSTRING:src_domain}\",\n            value: to_string($message.message),\n            only_named_captures: true\n        )\n    );\nend"}},"constraints":[{"type":"server-version","version":">=3.3.0+4ea5649"}]}]}